<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chat Agent MVP by Oni Charles</title>
  <style>
    body { 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
      max-width: 600px; 
      margin: 20px auto; 
      background: #f5f5f5;
    }
    h2 { color: #2c3e50; }
    #chat { 
      border: 1px solid #ddd; 
      padding: 15px; 
      height: 400px; 
      overflow-y: auto; 
      background: #fff; 
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .message { 
      margin: 10px 0; 
      padding: 10px; 
      border-radius: 8px; 
      animation: fadeIn 0.3s ease-in;
    }
    .user { 
      text-align: right; 
      color: #2c3e50; 
      background: #e3f2fd; 
    }
    .agent { 
      text-align: left; 
      color: #1a5c37; 
      background: #e8f5e9; 
    }
    .error { 
      text-align: left; 
      color: #d32f2f; 
      background: #ffebee; 
    }
    #inputArea { 
      margin-top: 15px; 
      display: flex; 
      gap: 10px; 
      align-items: center;
    }
    #userInput { 
      width: 70%; 
      padding: 8px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      font-size: 16px;
    }
    #sendBtn, #voiceBtn, #stopSpeechBtn { 
      padding: 8px 12px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      background: #1976d2; 
      color: #fff; 
      font-size: 14px;
    }
    #voiceBtn.listening { background: #d81b60; }
    #stopSpeechBtn { background: #d32f2f; }
    .loading::after { 
      content: '‚è≥'; 
      animation: spin 1s infinite; 
      margin-left: 5px;
    }
    .truncated::after { 
      content: '... [Show more]'; 
      color: #1976d2; 
      cursor: pointer;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<h2>AI Chat Agent MVP by Oni Charles</h2>

<div id="chat"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="Ask about Lalandi, DevSecOps, SAP, or my portfolio..." />
  <button id="sendBtn">Send</button>
  <button id="voiceBtn">üé§</button>
  <button id="stopSpeechBtn">Stop Speech</button>
</div>

<script>
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceBtn = document.getElementById('voiceBtn');
  const stopSpeechBtn = document.getElementById('stopSpeechBtn');
  let chatHistory = [];
  let currentUtterance = null;

  // Dataset
  const dataset = [
    {
      id: 'company-overview',
      subtopics: [
        {
          keywords: ['lalandi', 'conclusion', 'who is lalandi', 'what is lalandi'],
          weight: 2,
          answer: `Lalandi Conclusion is a Cape Town-based software development company established in 2006, part of the Dutch Conclusion group. We are trusted by clients in Africa and Europe for bespoke software solutions that blend artistry and technical expertise.`
        },
        {
          keywords: ['ecosystem', 'conclusion group', 'network'],
          weight: 1,
          answer: `As part of the Conclusion group, Lalandi operates in a unique ecosystem with over 30 expert companies, a 79% fan score, 4500+ professionals, and 500+ clients, enabling collaborative problem-solving.`
        }
      ]
    },
    {
      id: 'devsecops',
      subtopics: [
        {
          keywords: ['devsecops', 'security', 'automation', 'agile', 'lean'],
          weight: 2,
          answer: `Lalandi‚Äôs DevSecOps service integrates Engineering, Operations, and Security Compliance using Agile and Lean principles, offering leadership, team training, and standardized tools for efficient software delivery.`
        },
        {
          keywords: ['devsecops benefits', 'security benefits', 'why devsecops'],
          weight: 1,
          answer: `Our DevSecOps approach ensures rapid, secure software deployment by addressing secure design, governance, and skills gaps, promoting best practices across automated pipelines.`
        }
      ]
    },
    {
      id: 'sap-services',
      subtopics: [
        {
          keywords: ['sap', 'sap team', 'sap services'],
          weight: 2,
          answer: `Lalandi‚Äôs SAP team provides comprehensive support for SAP systems, focusing on stability, incident management, user support, and continuous improvement to drive efficiency and innovation.`
        },
        {
          keywords: ['system stability', 'sap stability'],
          weight: 1,
          answer: `We ensure SAP system stability by monitoring performance, minimizing downtime, and proactively resolving technical issues.`
        },
        {
          keywords: ['incident management', 'sap issues'],
          weight: 1,
          answer: `Our SAP team promptly resolves user-reported incidents like system errors or data inconsistencies to minimize business disruption.`
        },
        {
          keywords: ['user support', 'sap training'],
          weight: 1,
          answer: `We provide timely user support, including query resolution, system navigation assistance, and training to maximize SAP system usage.`
        }
      ]
    },
    {
      id: 'careers',
      subtopics: [
        {
          keywords: ['careers', 'jobs', 'work at lalandi', 'vacancies', 'join lalandi'],
          weight: 2,
          answer: `Join Lalandi Conclusion in Cape Town to work on meaningful IT projects with a collaborative team. Check our vacancies at https://www.conclusion.nl/en/lalandi#careers.`
        }
      ]
    },
    {
      id: 'expertise',
      subtopics: [
        {
          keywords: ['expertise', 'services', 'what we do', 'software', 'architecture', 'devops', 'consulting'],
          weight: 2,
          answer: `Lalandi specializes in software development, solution architecture, DevOps, and IT consulting to optimize business operations with cutting-edge technologies.`
        },
        {
          keywords: ['software development', 'build software'],
          weight: 1,
          answer: `We build bespoke software solutions with precision and artistry to meet business needs.`
        },
        {
          keywords: ['architecture', 'solution architecture'],
          weight: 1,
          answer: `Our proven solution architectures enable business growth through strategic technology applications.`
        }
      ]
    },
    {
      id: 'oni-charles',
      subtopics: [
        {
          keywords: ['oni charles', 'who is charles', 'oni', 'charles', 'what does Charles do', 'who build this app', 'kolapo',],
          weight: 2,
          answer: `Oni Charles is a self-taught Web3 developer skilled in JavaScript, Solidity, Python, React, Node.js, and AI tools like Gemini and OpenAI, with experience in building dApps and AI-driven solutions like this chatbot.`
        },
        {
          keywords: ['blockchain', 'web3', 'smart contracts'],
          weight: 1,
          answer: `I specialize in Web3 development, deploying decentralized applications with Solidity, Hardhat, and Ethereum, integrated with MetaMask and IPFS.`
        }
      ]
    },
    {
      id: 'portfolio',
      subtopics: [
        {
          keywords: ['portfolio', 'projects', 'work', 'examples'],
          weight: 2,
          answer: `Oni Charles‚Äô portfolio includes this AI chatbot (Gemini API, Web Speech API), a web scraper for Lalandi data, and Web3 dApps using React and Solidity. Ask for details or check my GitHub!`
        }
      ]
    },
    {
      id: 'ai-skills',
      subtopics: [
        {
          keywords: ['ai skills', 'machine learning', 'ai expertise', 'chatbot skills'],
          weight: 2,
          answer: `I built this chatbot to showcase my AI skills, integrating the Gemini API with web technologies and Web Speech API for voice input/output, complemented by experience with OpenAI and Hugging Face.`
        }
      ]
    }
  ];

  // Add message to chat window with truncation
  function addMessage(text, sender, fullText = text) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}`;
    const maxDisplayLength = 150;
    if (text.length > maxDisplayLength) {
      msgDiv.textContent = text.substring(0, maxDisplayLength);
      msgDiv.classList.add('truncated');
      msgDiv.onclick = () => {
        msgDiv.textContent = fullText;
        msgDiv.classList.remove('truncated');
      };
    } else {
      msgDiv.textContent = text;
    }
    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;
    chatHistory.push({ sender, text: fullText });
    if (chatHistory.length > 10) chatHistory.shift(); // Keep last 10 messages
  }

  // Speak text aloud
  function speak(text) {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel(); // Stop any ongoing speech
      currentUtterance = new SpeechSynthesisUtterance(text);
      currentUtterance.lang = 'en-US';
      currentUtterance.rate = 1.0;
      window.speechSynthesis.speak(currentUtterance);
    } else {
      addMessage('Text-to-speech not supported in this browser.', 'error');
    }
  }

  // Stop speech
  stopSpeechBtn.addEventListener('click', () => {
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      currentUtterance = null;
    }
  });

  // Voice recognition setup
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      voiceBtn.classList.remove('listening');
      sendMessage();
    };

    recognition.onstart = () => {
      voiceBtn.classList.add('listening');
      voiceBtn.textContent = 'üé§ Listening...';
    };

    recognition.onend = () => {
      voiceBtn.classList.remove('listening');
      voiceBtn.textContent = 'üé§';
    };

    recognition.onerror = (event) => {
      voiceBtn.classList.remove('listening');
      voiceBtn.textContent = 'üé§';
      addMessage('Voice recognition error: ' + event.error, 'error');
    };
  } else {
    voiceBtn.disabled = true;
    voiceBtn.textContent = 'Voice Not Supported';
  }

  // Advanced keyword matching with scoring
  function checkDataset(input) {
    const lowerInput = input.toLowerCase().trim();
    const inputWords = lowerInput.split(/\s+/);
    console.log('Checking dataset for:', lowerInput);

    let bestMatch = null;
    let highestScore = 0;

    for (const entry of dataset) {
      for (const subtopic of entry.subtopics) {
        let score = 0;
        subtopic.keywords.forEach(keyword => {
          const keywordLower = keyword.toLowerCase();
          if (keywordLower.includes(' ')) {
            if (lowerInput.includes(keywordLower)) score += subtopic.weight * 2;
          } else {
            if (inputWords.some(word => word.includes(keywordLower) || keywordLower.includes(word))) {
              score += subtopic.weight;
            }
          }
        });
        console.log(`Subtopic: ${subtopic.answer.substring(0, 30)}..., Score: ${score}`);
        if (score > highestScore) {
          highestScore = score;
          bestMatch = subtopic.answer;
        }
      }
    }

    if (highestScore > 0) {
      console.log('Dataset match found:', bestMatch);
      return bestMatch;
    }
    console.log('No dataset match, falling back to API');
    return null;
  }

  // Call Gemini API with context and history
  let lastApiCall = 0;
  async function callGeminiAPI(userText) {
    const apiKey = 'AIzaSyD1rrdR9nJs3TJCFYNlp1FfFWwhcJxoImo'; // Replace with your valid Gemini API key
    const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
    const minDelay = 4000; // 4 seconds to avoid rate limits

    // Enforce minimum delay
    const now = Date.now();
    const timeSinceLast = now - lastApiCall;
    if (timeSinceLast < minDelay) {
      await new Promise(resolve => setTimeout(resolve, minDelay - timeSinceLast));
    }

    // Build context with dataset and history
    const datasetContext = dataset.map(entry => 
      entry.subtopics.map(sub => sub.answer).join('\n')
    ).join('\n\n');
    const historyContext = chatHistory
      .slice(-4)
      .map(msg => `${msg.sender === 'user' ? 'User' : 'Assistant'}: ${msg.text}`)
      .join('\n');
    const prompt = `You are an AI assistant for Lalandi Conclusion, a Cape Town-based software development company. Use the following knowledge base to answer queries precisely in 2-3 sentences, focusing on Lalandi‚Äôs services (DevSecOps, SAP, software development, IT consulting), company details, or Oni Charles‚Äô portfolio. If the query is unrelated, provide a concise general response.

Knowledge Base:
${datasetContext}

Chat History:
${historyContext}

User Query: ${userText}`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }]
    };

    try {
      const response = await fetch(url + '?key=' + apiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      lastApiCall = Date.now();

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Gemini API error:', response.status, response.statusText, errorText);
        return `Sorry, I am having trouble connecting to the AI service: ${response.status} ${response.statusText}`;
      }

      const data = await response.json();
      const generatedText = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I did not understand that.';
      console.log('API response:', data);
      return generatedText;

    } catch (error) {
      console.error('Fetch error:', error);
      return 'Error connecting to AI service: ' + error.message;
    }
  }

  // Send message handler
  async function sendMessage() {
    const input = userInput.value.trim();
    if (!input) {
      addMessage('Please enter a message.', 'error');
      return;
    }

    addMessage(input, 'user');
    userInput.value = '';

    // Check dataset first
    const datasetReply = checkDataset(input);
    if (datasetReply) {
      addMessage(datasetReply, 'agent', datasetReply);
      speak(datasetReply);
      return;
    }

    // Show loading message
    addMessage('Thinking...', 'agent');
    const aiReply = await callGeminiAPI(input);
    chat.lastChild.remove(); // Remove "Thinking..." message
    addMessage(aiReply, 'agent', aiReply);
    speak(aiReply);
  }

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
  voiceBtn.addEventListener('click', () => {
    if (recognition) recognition.start();
  });

  // Welcome message
  addMessage(
    `Welcome to Oni Charles' AI Chat Agent! Ask about:
- Lalandi Conclusion (e.g., "What is Lalandi?", "SAP services")
- DevSecOps or SAP specifics (e.g., "Why DevSecOps?", "SAP stability")
- Careers at Lalandi (e.g., "Jobs at Lalandi")
- My portfolio (e.g., "Who is Oni Charles?", "Show projects")
Use the üé§ for voice input or "Stop Speech" to pause narration.`,
    'agent'
  );

</script>

</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AI Chat Agent MVP by Oni Charles</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 600px;
      margin: 20px auto;
      background: #f5f5f5;
    }
    h2 { color: #2c3e50; }
    #chat {
      border: 1px solid #ddd;
      padding: 15px;
      height: 400px;
      overflow-y: auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .message {
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
      animation: fadeIn 0.3s ease-in;
    }
    .user {
      text-align: right;
      color: #2c3e50;
      background: #e3f2fd;
    }
    .agent {
      text-align: left;
      color: #1a5c37;
      background: #e8f5e9;
    }
    .error {
      text-align: left;
      color: #d32f2f;
      background: #ffebee;
    }
    .confidence {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    #inputArea {
      margin-top: 15px;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #userInput {
      width: 70%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    #sendBtn, #voiceBtn, #stopSpeechBtn {
      padding: 8px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: #1976d2;
      color: #fff;
      font-size: 14px;
    }
    #voiceBtn.listening { background: #d81b60; }
    #stopSpeechBtn { background: #d32f2f; }
    .loading::after {
      content: '‚è≥';
      display: inline-block;
      animation: spin 1s linear infinite;
      margin-left: 5px;
    }
    .truncated::after {
      content: '... [Show more]';
      color: #1976d2;
      cursor: pointer;
    }
    .highlight {
      background: #fff3cd;
      padding: 2px 4px;
      border-radius: 3px;
    }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes spin { 100% { transform: rotate(360deg); } }
  </style>
</head>
<body>

<h2>AI Chat Agent MVP by Oni Charles</h2>

<div id="chat" role="log" aria-live="polite" aria-busy="false"></div>

<div id="inputArea">
  <input type="text" id="userInput" placeholder="Ask about Lalandi, DevSecOps, SAP, or my portfolio..." aria-label="Chat input" />
  <button id="sendBtn" aria-label="Send message">Send</button>
  <button id="voiceBtn" aria-label="Start voice input">üé§</button>
  <button id="stopSpeechBtn" aria-label="Stop speech">Stop Speech</button>
</div>

<script>
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');
  const voiceBtn = document.getElementById('voiceBtn');
  const stopSpeechBtn = document.getElementById('stopSpeechBtn');
  let chatHistory = [];
  let currentUtterance = null;
  let currentAudio = null;
  let lastMatchedId = null;
  const audioCache = new Map(); // Cache for audio blobs

  // Dataset
  const dataset = [
    {
      id: 'company-overview',
      subtopics: [
        {
          keywords: ['lalandi', 'conclusion', 'who is lalandi', 'what is lalandi', 'lalandi conclusion', 'about lalandi', 'what does lalandi do'],
          weight: 2,
          answer: `Lalandi Conclusion, established in 2006 in Cape Town, is a software development company within the Dutch Conclusion group, delivering bespoke solutions that blend artistry and technical expertise to clients in Africa and Europe.`
        },
        {
          keywords: ['ecosystem', 'conclusion group', 'network', 'collaboration'],
          weight: 1,
          answer: `Lalandi operates within the Conclusion group‚Äôs ecosystem, comprising over 30 expert companies, 4500+ professionals, 500+ clients, and a 79% fan score, enabling collaborative and innovative problem-solving.`
        },
        {
          keywords: ['team', 'farzaana', 'marcel', 'taureen', 'lalandi team'],
          weight: 1,
          answer: `Lalandi‚Äôs team includes experts like Farzaana, Marcel, and Taureen, who contribute to crafting strategic software solutions with creativity and precision.`
        },
        {
          keywords: ['marion', 'marion mugabirwa', 'mugabirwa'],
          weight: 1,
          answer: `Marion Mugabirwa is a key team member at Lalandi Conclusion, contributing to innovative IT projects and collaborative solutions.`
        },
        {
          keywords: ['shannon', 'shannon smiling'],
          weight: 1,
          answer: `Shannon is a valued team member at Lalandi Conclusion, working on meaningful IT projects with a collaborative spirit.`
        }
      ]
    },
    {
      id: 'devsecops',
      subtopics: [
        {
          keywords: ['devsecops', 'security', 'automation', 'agile', 'lean', 'devops'],
          weight: 2,
          answer: `Lalandi‚Äôs DevSecOps service integrates Engineering, Operations, and Security Compliance using Agile and Lean principles, offering leadership, training, and standardized tools for efficient, secure software delivery.`
        },
        {
          keywords: ['devsecops benefits', 'security benefits', 'why devsecops', 'devsecops advantages'],
          weight: 1,
          answer: `Our DevSecOps approach ensures rapid, secure software deployment by addressing design, governance, and skills gaps, with standardized tools and best practices.`
        }
      ]
    },
    {
      id: 'sap-services',
      subtopics: [
        {
          keywords: ['sap', 'sap team', 'sap services', 'sap system'],
          weight: 2,
          answer: `Lalandi‚Äôs SAP team provides comprehensive support for SAP systems, focusing on stability, incident management, user support, and continuous improvement to drive efficiency and innovation.`
        },
        {
          keywords: ['system stability', 'sap stability', 'sap performance'],
          weight: 1,
          answer: `We ensure SAP system stability by monitoring performance, minimizing downtime, and proactively resolving technical issues.`
        },
        {
          keywords: ['incident management', 'sap issues', 'sap errors'],
          weight: 1,
          answer: `Our SAP team resolves user-reported incidents like system errors or data inconsistencies to minimize business disruption.`
        },
        {
          keywords: ['user support', 'sap training', 'sap help'],
          weight: 1,
          answer: `We offer timely SAP user support, including query resolution, navigation assistance, and training to maximize system usage.`
        },
        {
          keywords: ['change management', 'sap updates', 'sap upgrades'],
          weight: 1,
          answer: `Lalandi manages SAP system changes, including patches and upgrades, adhering to strict change management processes.`
        }
      ]
    },
    {
      id: 'careers',
      subtopics: [
        {
          keywords: ['careers', 'jobs', 'work at lalandi', 'vacancies', 'join lalandi', 'employment'],
          weight: 2,
          answer: `Join Lalandi Conclusion in Cape Town to work on meaningful IT projects with a collaborative team. Check our vacancies at https://www.conclusion.nl/en/lalandi#careers.`
        }
      ]
    },
    {
      id: 'expertise',
      subtopics: [
        {
          keywords: ['expertise', 'services', 'what we do', 'lalandi services', 'software', 'architecture', 'devops', 'consulting'],
          weight: 2,
          answer: `Lalandi specializes in software development, solution architecture, DevOps, and IT consulting to optimize business operations with cutting-edge technologies.`
        },
        {
          keywords: ['software development', 'build software', 'software solutions'],
          weight: 1,
          answer: `We build bespoke software solutions with precision and artistry to meet business needs.`
        },
        {
          keywords: ['architecture', 'solution architecture', 'system architecture'],
          weight: 1,
          answer: `Our proven solution architectures enable business growth through strategic technology applications.`
        },
        {
          keywords: ['it consulting', 'consulting services', 'tech consulting'],
          weight: 1,
          answer: `Lalandi‚Äôs IT consulting leverages cutting-edge technologies to optimize digital infrastructure and drive innovation.`
        }
      ]
    },
    {
      id: 'oni-charles',
      subtopics: [
        {
          keywords: ['oni charles', 'who is charles', 'oni', 'charles', 'kolapo', 'who built this app', 'developer'],
          weight: 2,
          answer: `Oni Charles is a self-taught Web3 developer skilled in JavaScript, Solidity, Python, React, Node.js, and AI tools like Gemini and OpenAI, with experience in building dApps and AI-driven solutions like this chatbot.`
        },
        {
          keywords: ['blockchain', 'web3', 'smart contracts', 'decentralized apps'],
          weight: 1,
          answer: `I specialize in Web3 development, deploying decentralized applications with Solidity, Hardhat, and Ethereum, integrated with MetaMask and IPFS.`
        }
      ]
    },
    {
      id: 'portfolio',
      subtopics: [
        {
          keywords: ['portfolio', 'projects', 'work', 'examples', 'oni projects'],
          weight: 2,
          answer: `Oni Charles‚Äô portfolio includes this AI chatbot (Gemini API, Web Speech API), a web scraper for Lalandi data, and Web3 dApps using React and Solidity. Ask for details or check my GitHub!`
        }
      ]
    },
    {
      id: 'ai-skills',
      subtopics: [
        {
          keywords: ['ai skills', 'machine learning', 'ai expertise', 'chatbot skills', 'ai development'],
          weight: 2,
          answer: `I built this chatbot to showcase my AI skills, integrating the Gemini API with web technologies and Web Speech API, complemented by experience with OpenAI and Hugging Face.`
        }
      ]
    },
    {
      id: 'greeting',
      subtopics: [
        {
          keywords: ['hello', 'how are you', 'what are you up to', 'hi', 'hello there'],
          weight: 2,
          answer: `Hi! I'm Oni Charles' AI Chat Agent. Ask about Lalandi Conclusion, DevSecOps, SAP, careers, or my portfolio. Use the üé§ for voice input or "Stop Speech" to pause narration.`
        }
      ]
    }
  ];

  // Preload audio for greeting
  (async () => {
    const greeting = dataset.find(entry => entry.id === 'greeting').subtopics[0].answer;
    await speak(greeting, true); // Cache greeting audio
  })();

  // Simple fuzzy matching (Levenshtein distance)
  function levenshtein(a, b) {
    const matrix = Array(b.length + 1).fill().map(() => Array(a.length + 1).fill(0));
    for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
    for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
    for (let j = 1; j <= b.length; j++) {
      for (let i = 1; i <= a.length; i++) {
        const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
        matrix[j][i] = Math.min(
          matrix[j][i - 1] + 1,
          matrix[j - 1][i] + 1,
          matrix[j - 1][i - 1] + indicator
        );
      }
    }
    return matrix[b.length][a.length];
  }

  // Advanced keyword matching with fuzzy matching
  function checkDataset(input) {
    const lowerInput = input.toLowerCase().trim();
    const inputWords = lowerInput.split(/\s+/);
    console.log('Checking dataset for:', lowerInput);

    let bestMatch = null;
    let highestScore = 0;
    let matchedId = null;
    let confidence = 0;

    // Check for follow-up queries
    const isFollowUp = lowerInput.includes('more') || lowerInput.includes('tell me more') || lowerInput.includes('expand');
    if (isFollowUp && lastMatchedId) {
      const lastEntry = dataset.find(entry => entry.id === lastMatchedId);
      if (lastEntry) {
        const longestAnswer = lastEntry.subtopics.reduce((prev, curr) =>
          prev.answer.length > curr.answer.length ? prev : curr
        );
        console.log('Follow-up detected, returning:', longestAnswer.answer);
        return { answer: longestAnswer.answer, confidence: 0.9 };
      }
    }

    for (const entry of dataset) {
      for (const subtopic of entry.subtopics) {
        let score = 0;
        let matchedKeywords = [];
        subtopic.keywords.forEach(keyword => {
          const keywordLower = keyword.toLowerCase();
          if (keywordLower.includes(' ')) {
            if (lowerInput.includes(keywordLower)) {
              score += subtopic.weight * 3;
              matchedKeywords.push(keywordLower);
            }
          } else {
            inputWords.forEach(word => {
              if (word.includes(keywordLower) || keywordLower.includes(word)) {
                score += subtopic.weight;
                matchedKeywords.push(keywordLower);
              } else if (levenshtein(word, keywordLower) <= 2) {
                score += subtopic.weight * 0.5;
                matchedKeywords.push(keywordLower);
              }
            });
          }
        });
        console.log(`Subtopic: ${subtopic.answer.substring(0, 30)}..., Score: ${score}, Keywords: ${matchedKeywords}`);
        if (score > highestScore) {
          highestScore = score;
          bestMatch = subtopic.answer;
          matchedId = entry.id;
          confidence = Math.min(score / 10, 1);
        }
      }
    }

    if (highestScore > 1) {
      console.log('Dataset match found:', bestMatch);
      lastMatchedId = matchedId;
      return { answer: bestMatch, confidence };
    }
    console.log('No dataset match, falling back to API');
    lastMatchedId = null;
    return null;
  }

  // Add message with keyword highlighting and confidence
  function addMessage(text, sender, fullText = text, confidence = null) {
    const msgDiv = document.createElement('div');
    msgDiv.className = `message ${sender}`;
    const maxDisplayLength = 150;
    let displayText = text;

    // Highlight matched keywords
    const inputWords = userInput.value.toLowerCase().trim().split(/\s+/);
    inputWords.forEach(word => {
      if (word.length > 3) {
        const regex = new RegExp(`\\b${word}\\b`, 'gi');
        displayText = displayText.replace(regex, `<span class="highlight">${word}</span>`);
      }
    });

    if (text.length > maxDisplayLength) {
      msgDiv.innerHTML = displayText.substring(0, maxDisplayLength);
      msgDiv.classList.add('truncated');
      msgDiv.onclick = () => {
        msgDiv.innerHTML = displayText;
        msgDiv.classList.remove('truncated');
      };
    } else {
      msgDiv.innerHTML = displayText;
    }

    if (confidence !== null) {
      const confDiv = document.createElement('div');
      confDiv.className = 'confidence';
      confDiv.textContent = `Confidence: ${(confidence * 100).toFixed(0)}%`;
      msgDiv.appendChild(confDiv);
    }

    chat.appendChild(msgDiv);
    chat.scrollTop = chat.scrollHeight;
    chatHistory.push({ sender, text: fullText });
    if (chatHistory.length > 10) chatHistory.shift();
    chat.setAttribute('aria-busy', 'false');
  }

  // Speak text using ElevenLabs TTS with Web Speech API fallback
  async function speak(text, cacheOnly = false) {
    const apiKey = 'sk_7366bbdd8deefc2be8e95fa6187193dda0276d8fe4e2c6de'; // Replace with your ElevenLabs API key
    const voiceId = 'pNInz6obpgDQGcFmaJgB'; // Adam voice (realistic US male)
    const url = `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}/stream`; // Try streaming endpoint

    // Check cache
    if (audioCache.has(text)) {
      console.log('Using cached audio for:', text.substring(0, 30));
      const audioUrl = audioCache.get(text);.
      if (!cacheOnly) {
        currentAudio = new Audio(audioUrl);
        currentAudio.play();
        currentAudio.onended = () => {
          currentAudio = null;
        };
      }
      return;
    }

    // Stop any ongoing speech
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      currentUtterance = null;
    }

    // Try ElevenLabs API with retries
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'xi-api-key': apiKey,
            'Content-Type': 'application/json',
            'accept': 'audio/mpeg'
          },
          body: JSON.stringify({
            text: text,
            model_id: 'eleven_monolingual_v1',
            voice_settings: {
              stability: 0.5,
              similarity_boost: 0.75
            }
          })
        });

        if (response.status === 429) {
          console.warn(`Rate limit hit, retrying (${attempt}/3)...`);
          await new Promise(resolve => setTimeout(resolve, 1000));
          continue;
        }

        if (!response.ok) {
          const errorText = await response.text();
          console.error('ElevenLabs error:', response.status, response.statusText, errorText);
          throw new Error(`ElevenLabs API error: ${response.status} ${response.statusText}`);
        }

        const audioBlob = await response.blob();
        const audioUrl = URL.createObjectURL(audioBlob);
        audioCache.set(text, audioUrl);
        if (audioCache.size > 5) {
          const firstKey = audioCache.keys().next().value;
          URL.revokeObjectURL(audioCache.get(firstKey));
          audioCache.delete(firstKey);
        }

        if (!cacheOnly) {
          currentAudio = new Audio(audioUrl);
          currentAudio.play();
          currentAudio.onended = () => {
            currentAudio = null;
          };
        }
        return;
      } catch (error) {
        console.error('ElevenLabs fetch error:', error);
        if (attempt === 3) {
          addMessage('Failed to generate realistic voice: ' + (error.message.includes('401') ? 'Invalid API key' : error.message.includes('429') ? 'Quota exceeded' : 'Unknown error') + '. Using fallback voice.', 'error');
          // Fallback to Web Speech API
          if ('speechSynthesis' in window) {
            currentUtterance = new SpeechSynthesisUtterance(text);
            currentUtterance.lang = 'en-US';
            currentUtterance.rate = 1.0;
            window.speechSynthesis.speak(currentUtterance);
          } else {
            addMessage('Text-to-speech not supported in this browser.', 'error');
          }
        }
      }
    }
  }

  // Stop speech (handles both ElevenLabs and Web Speech API)
  stopSpeechBtn.addEventListener('click', () => {
    if (currentAudio) {
      currentAudio.pause();
      currentAudio = null;
    }
    if ('speechSynthesis' in window) {
      window.speechSynthesis.cancel();
      currentUtterance = null;
    }
  });

  // Voice recognition setup
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  let recognition;
  if (SpeechRecognition) {
    recognition = new SpeechRecognition();
    recognition.lang = 'en-US';
    recognition.continuous = false;
    recognition.interimResults = false;

    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      userInput.value = transcript;
      voiceBtn.classList.remove('listening');
      sendMessage();
    };

    recognition.onstart = () => {
      voiceBtn.classList.add('listening');
      voiceBtn.textContent = 'üé§ Listening...';
    };

    recognition.onend = () => {
      voiceBtn.classList.remove('listening');
      voiceBtn.textContent = 'üé§';
    };

    recognition.onerror = (event) => {
      voiceBtn.classList.remove('listening');
      voiceBtn.textContent = 'üé§';
      addMessage('Voice recognition error: ' + event.error, 'error');
    };
  } else {
    voiceBtn.disabled = true;
    voiceBtn.textContent = 'Voice Not Supported';
  }

  // Call Gemini API with enhanced prompt
  let lastApiCall = 0;
  async function callGeminiAPI(userText) {
    const apiKey = 'AIzaSyD1rrdR9nJs3TJCFYNlp1FfFWwhcJxoImo'; // Replace with your valid Gemini API key
    const url = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent';
    const minDelay = 4000;

    // Enforce minimum delay
    const now = Date.now();
    const timeSinceLast = now - lastApiCall;
    if (timeSinceLast < minDelay) {
      await new Promise(resolve => setTimeout(resolve, minDelay - timeSinceLast));
    }

    // Build context
    const datasetContext = dataset.map(entry =>
      entry.subtopics.map(sub => sub.answer).join('\n')
    ).join('\n\n');
    const historyContext = chatHistory
      .slice(-4)
      .map(msg => `${msg.sender === 'user' ? 'User' : 'Assistant'}: ${msg.text}`)
      .join('\n');
    const prompt = `You are an AI assistant for Lalandi Conclusion, a Cape Town-based software development company. Answer the query in 2-3 concise sentences (max 50 words) using the knowledge base below, prioritizing Lalandi‚Äôs services (DevSecOps, SAP, software development, IT consulting), company details, or Oni Charles‚Äô portfolio. For unrelated queries, provide a brief general response.

Knowledge Base:
${datasetContext}

Chat History:
${historyContext}

User Query: ${userText}`;

    const body = {
      contents: [{ parts: [{ text: prompt }] }]
    };

    try {
      const response = await fetch(url + '?key=' + apiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(body)
      });

      lastApiCall = Date.now();

      if (!response.ok) {
        const errorText = await response.text();
        console.error('Gemini API error:', response.status, response.statusText, errorText);
        return `Sorry, I am having trouble connecting to the AI service: ${response.status} ${response.statusText}`;
      }

      const data = await response.json();
      const generatedText = data?.candidates?.[0]?.content?.parts?.[0]?.text || 'Sorry, I did not understand that.';
      console.log('API response:', data);
      return generatedText;
    } catch (error) {
      console.error('Fetch error:', error);
      return 'Error connecting to AI service: ' + error.message;
    }
  }

  // Debounce function to prevent rapid submissions
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }

  // Send message handler
  const sendMessage = debounce(async () => {
    const input = userInput.value.trim();
    if (!input) {
      addMessage('Please enter a message.', 'error');
      return;
    }

    addMessage(input, 'user');
    userInput.value = '';
    userInput.focus();
    chat.setAttribute('aria-busy', 'true');

    // Check dataset
    addMessage('Typing...', 'agent loading');
    const datasetResult = checkDataset(input);
    if (datasetResult) {
      chat.lastChild.remove();
      addMessage(datasetResult.answer, 'agent', datasetResult.answer, datasetResult.confidence);
      await speak(datasetResult.answer);
      return;
    }

    // API fallback
    chat.lastChild.remove();
    addMessage('Thinking...', 'agent loading');
    const aiReply = await callGeminiAPI(input);
    chat.lastChild.remove();
    addMessage(aiReply, 'agent', aiReply);
    await speak(aiReply);
  }, 300);

  // Event listeners
  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') sendMessage();
  });
  voiceBtn.addEventListener('click', () => {
    if (recognition) recognition.start();
  });

  // Welcome message
  addMessage(
    `Hi! I'm Oni Charles' AI Chat Agent. Ask about Lalandi Conclusion, DevSecOps, SAP, careers, or my portfolio. Use the üé§ for voice input or "Stop Speech" to pause narration.`,
    'agent'
  );
</script>

</body>
</html>
